#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <math.h>
#include <time.h>
#include <vector>
#include <fstream>

#include "mailbox.h"
#include "gpu_fft.h"

using namespace std;

char Usage[] =
    "Usage: hello_fft.bin log2_N [jobs [loops]]\n"
    "log2_N = log2(FFT_length),       log2_N = 8...22\n"
    "jobs   = transforms per batch,   jobs>0,        default 1\n"
    "loops  = number of test repeats, loops>0,       default 1\n";


vector<float> getInput(int nfreq) {
    int n=1024;

    vector<float> values;

    for(int i=0; i<n; i++)
        values.push_back(0);

    vector<float> freq;

    for(int i=0; i<nfreq; i++)
        freq.push_back(i+1);

    for(float f : freq)
        for(int i=0; i<values.size(); i++)
                values[i] += sin(2*M_PI*f*i/n);
    return values;
}

float sine02[] = {2.000000,1.999962,1.999849,1.999660,1.999397,1.999058,1.998644,1.998155,1.997590,1.996950,1.996235,1.995445,1.994580,1.993640,1.992625,1.991534,1.990369,1.989128,1.987813,1.986423,1.984958,1.983419,1.981805,1.980116,1.978352,1.976514,1.974602,1.972615,1.970554,1.968419,1.966210,1.963927,1.961570,1.959139,1.956634,1.954056,1.951404,1.948678,1.945879,1.943007,1.940062,1.937043,1.933952,1.930788,1.927551,1.924242,1.920860,1.917406,1.913880,1.910281,1.906611,1.902869,1.899056,1.895170,1.891214,1.887186,1.883087,1.878917,1.874677,1.870366,1.865985,1.861533,1.857011,1.852419,1.847759,1.843027,1.838227,1.833358,1.828419,1.823412,1.818336,1.813191,1.807978,1.802697,1.797348,1.791932,1.786448,1.780897,1.775279,1.769593,1.763842,1.758023,1.752139,1.746189,1.740173,1.734092,1.727945,1.721733,1.715457,1.709115,1.702709,1.696240,1.689706,1.683109,1.676449,1.669725,1.662939,1.656090,1.649178,1.642205,1.635169,1.628072,1.620914,1.613695,1.606414,1.599074,1.591673,1.584212,1.576692,1.569112,1.561474,1.553776,1.546020,1.538206,1.530334,1.522404,1.514417,1.506373,1.498272,1.490115,1.481902,1.473632,1.465308,1.456928,1.448493,1.440004,1.431461,1.422863,1.414213,1.405509,1.396752,1.387942,1.379081,1.370167,1.361202,1.352185,1.343117,1.333999,1.324831,1.315613,1.306345,1.297028,1.287663,1.278248,1.268786,1.259276,1.249718,1.240114,1.230463,1.220765,1.211021,1.201232,1.191398,1.181518,1.171595,1.161627,1.151616,1.141560,1.131463,1.121322,1.111140,1.100916,1.090650,1.080343,1.069995,1.059607,1.049179,1.038712,1.028205,1.017660,1.007076,0.996455,0.985796,0.975100,0.964367,0.953598,0.942793,0.931952,0.921077,0.910167,0.899222,0.888243,0.877232,0.866187,0.855110,0.844000,0.832858,0.821686,0.810482,0.799248,0.787983,0.776689,0.765367,0.754015,0.742634,0.731226,0.719790,0.708327,0.696837,0.685321,0.673779,0.662212,0.650620,0.639004,0.627363,0.615699,0.604012,0.592301,0.580569,0.568814,0.557039,0.545242,0.533425,0.521588,0.509731,0.497855,0.485960,0.474046,0.462116,0.450167,0.438202,0.426220,0.414222,0.402209,0.390181,0.378137,0.366080,0.354008,0.341924,0.329826,0.317716,0.305594,0.293461,0.281316,0.269161,0.256996,0.244821,0.232637,0.220444,0.208243,0.196034,0.183818,0.171594,0.159365,0.147129,0.134887,0.122641,0.110390,0.098135,0.085876,0.073614,0.061349,0.049082,0.036813,0.024543,0.012271,0.000000,-0.012272,-0.024543,-0.036813,-0.049083,-0.061350,-0.073614,-0.085876,-0.098135,-0.110391,-0.122642,-0.134888,-0.147129,-0.159365,-0.171595,-0.183818,-0.196034,-0.208244,-0.220445,-0.232637,-0.244822,-0.256997,-0.269162,-0.281317,-0.293461,-0.305595,-0.317717,-0.329826,-0.341924,-0.354009,-0.366080,-0.378138,-0.390181,-0.402209,-0.414223,-0.426221,-0.438203,-0.450168,-0.462116,-0.474047,-0.485960,-0.497855,-0.509731,-0.521588,-0.533425,-0.545243,-0.557039,-0.568815,-0.580569,-0.592302,-0.604012,-0.615699,-0.627364,-0.639004,-0.650621,-0.662213,-0.673780,-0.685322,-0.696838,-0.708327,-0.719790,-0.731226,-0.742635,-0.754015,-0.765367,-0.776690,-0.787984,-0.799248,-0.810483,-0.821686,-0.832859,-0.844000,-0.855110,-0.866187,-0.877232,-0.888244,-0.899222,-0.910167,-0.921077,-0.931953,-0.942793,-0.953598,-0.964368,-0.975100,-0.985796,-0.996455,-1.007077,-1.017660,-1.028205,-1.038712,-1.049179,-1.059607,-1.069995,-1.080343,-1.090650,-1.100916,-1.111140,-1.121323,-1.131464,-1.141561,-1.151616,-1.161628,-1.171595,-1.181519,-1.191398,-1.201233,-1.211022,-1.220765,-1.230463,-1.240114,-1.249719,-1.259276,-1.268786,-1.278249,-1.287663,-1.297028,-1.306345,-1.315613,-1.324831,-1.333999,-1.343118,-1.352185,-1.361202,-1.370167,-1.379081,-1.387943,-1.396752,-1.405509,-1.414214,-1.422864,-1.431461,-1.440005,-1.448494,-1.456928,-1.465308,-1.473633,-1.481902,-1.490115,-1.498272,-1.506373,-1.514417,-1.522404,-1.530334,-1.538206,-1.546021,-1.553776,-1.561474,-1.569113,-1.576692,-1.584213,-1.591673,-1.599074,-1.606414,-1.613694,-1.620914,-1.628072,-1.635169,-1.642205,-1.649178,-1.656089,-1.662939,-1.669725,-1.676449,-1.683110,-1.689707,-1.696240,-1.702710,-1.709115,-1.715457,-1.721733,-1.727945,-1.734092,-1.740173,-1.746189,-1.752140,-1.758024,-1.763842,-1.769594,-1.775279,-1.780897,-1.786448,-1.791932,-1.797348,-1.802697,-1.807978,-1.813191,-1.818335,-1.823412,-1.828419,-1.833358,-1.838227,-1.843027,-1.847759,-1.852420,-1.857012,-1.861533,-1.865985,-1.870367,-1.874678,-1.878918,-1.883088,-1.887186,-1.891214,-1.895170,-1.899056,-1.902869,-1.906611,-1.910282,-1.913880,-1.917406,-1.920860,-1.924242,-1.927552,-1.930788,-1.933952,-1.937043,-1.940062,-1.943007,-1.945879,-1.948678,-1.951404,-1.954056,-1.956634,-1.959139,-1.961570,-1.963927,-1.966211,-1.968420,-1.970555,-1.972616,-1.974602,-1.976514,-1.978352,-1.980116,-1.981804,-1.983419,-1.984958,-1.986423,-1.987813,-1.989128,-1.990369,-1.991534,-1.992624,-1.993640,-1.994580,-1.995445,-1.996236,-1.996950,-1.997590,-1.998154,-1.998644,-1.999058,-1.999397,-1.999660,-1.999849,-1.999961,-2.000000,-1.999962,-1.999849,-1.999660,-1.999397,-1.999058,-1.998644,-1.998155,-1.997590,-1.996950,-1.996235,-1.995445,-1.994580,-1.993640,-1.992625,-1.991534,-1.990369,-1.989128,-1.987813,-1.986423,-1.984958,-1.983419,-1.981805,-1.980116,-1.978352,-1.976514,-1.974602,-1.972615,-1.970554,-1.968419,-1.966210,-1.963927,-1.961570,-1.959139,-1.956634,-1.954056,-1.951404,-1.948678,-1.945879,-1.943007,-1.940062,-1.937043,-1.933952,-1.930788,-1.927551,-1.924242,-1.920860,-1.917406,-1.913880,-1.910281,-1.906611,-1.902869,-1.899056,-1.895170,-1.891214,-1.887186,-1.883087,-1.878917,-1.874677,-1.870366,-1.865985,-1.861533,-1.857011,-1.852419,-1.847759,-1.843027,-1.838227,-1.833358,-1.828419,-1.823412,-1.818336,-1.813191,-1.807978,-1.802697,-1.797348,-1.791932,-1.786448,-1.780897,-1.775279,-1.769593,-1.763842,-1.758023,-1.752139,-1.746189,-1.740173,-1.734092,-1.727945,-1.721733,-1.715457,-1.709115,-1.702709,-1.696240,-1.689706,-1.683109,-1.676449,-1.669725,-1.662939,-1.656090,-1.649178,-1.642205,-1.635169,-1.628072,-1.620914,-1.613695,-1.606414,-1.599074,-1.591673,-1.584212,-1.576692,-1.569112,-1.561474,-1.553776,-1.546020,-1.538206,-1.530334,-1.522404,-1.514417,-1.506373,-1.498272,-1.490115,-1.481902,-1.473632,-1.465308,-1.456928,-1.448493,-1.440004,-1.431461,-1.422863,-1.414213,-1.405509,-1.396752,-1.387942,-1.379081,-1.370167,-1.361202,-1.352185,-1.343117,-1.333999,-1.324831,-1.315613,-1.306345,-1.297028,-1.287663,-1.278248,-1.268786,-1.259276,-1.249718,-1.240114,-1.230463,-1.220765,-1.211021,-1.201232,-1.191398,-1.181518,-1.171595,-1.161627,-1.151616,-1.141560,-1.131463,-1.121322,-1.111140,-1.100916,-1.090650,-1.080343,-1.069995,-1.059607,-1.049179,-1.038712,-1.028205,-1.017660,-1.007076,-0.996455,-0.985796,-0.975100,-0.964367,-0.953598,-0.942793,-0.931952,-0.921077,-0.910167,-0.899222,-0.888243,-0.877232,-0.866187,-0.855110,-0.844000,-0.832858,-0.821686,-0.810482,-0.799248,-0.787983,-0.776689,-0.765367,-0.754015,-0.742634,-0.731226,-0.719790,-0.708327,-0.696837,-0.685321,-0.673779,-0.662212,-0.650620,-0.639004,-0.627363,-0.615699,-0.604012,-0.592301,-0.580569,-0.568814,-0.557039,-0.545242,-0.533425,-0.521588,-0.509731,-0.497855,-0.485960,-0.474046,-0.462116,-0.450167,-0.438202,-0.426220,-0.414222,-0.402209,-0.390181,-0.378137,-0.366080,-0.354008,-0.341924,-0.329826,-0.317716,-0.305594,-0.293461,-0.281316,-0.269161,-0.256996,-0.244821,-0.232637,-0.220444,-0.208243,-0.196034,-0.183818,-0.171594,-0.159365,-0.147129,-0.134887,-0.122641,-0.110390,-0.098135,-0.085876,-0.073614,-0.061349,-0.049082,-0.036813,-0.024543,-0.012271,0.000000,0.012272,0.024543,0.036813,0.049083,0.061350,0.073614,0.085876,0.098135,0.110391,0.122642,0.134888,0.147129,0.159365,0.171595,0.183818,0.196034,0.208244,0.220445,0.232637,0.244822,0.256997,0.269162,0.281317,0.293461,0.305595,0.317717,0.329826,0.341924,0.354009,0.366080,0.378138,0.390181,0.402209,0.414223,0.426221,0.438203,0.450168,0.462116,0.474047,0.485960,0.497855,0.509731,0.521588,0.533425,0.545243,0.557039,0.568815,0.580569,0.592302,0.604012,0.615699,0.627364,0.639004,0.650621,0.662213,0.673780,0.685322,0.696838,0.708327,0.719790,0.731226,0.742635,0.754015,0.765367,0.776690,0.787984,0.799248,0.810483,0.821686,0.832859,0.844000,0.855110,0.866187,0.877232,0.888244,0.899222,0.910167,0.921077,0.931953,0.942793,0.953598,0.964368,0.975100,0.985796,0.996455,1.007077,1.017660,1.028205,1.038712,1.049179,1.059607,1.069995,1.080343,1.090650,1.100916,1.111140,1.121323,1.131464,1.141561,1.151616,1.161628,1.171595,1.181519,1.191398,1.201233,1.211022,1.220765,1.230463,1.240114,1.249719,1.259276,1.268786,1.278249,1.287663,1.297028,1.306345,1.315613,1.324831,1.333999,1.343118,1.352185,1.361202,1.370167,1.379081,1.387943,1.396752,1.405509,1.414214,1.422864,1.431461,1.440005,1.448494,1.456928,1.465308,1.473633,1.481902,1.490115,1.498272,1.506373,1.514417,1.522404,1.530334,1.538206,1.546021,1.553776,1.561474,1.569113,1.576692,1.584213,1.591673,1.599074,1.606414,1.613694,1.620914,1.628072,1.635169,1.642205,1.649178,1.656089,1.662939,1.669725,1.676449,1.683110,1.689707,1.696240,1.702710,1.709115,1.715457,1.721733,1.727945,1.734092,1.740173,1.746189,1.752140,1.758024,1.763842,1.769594,1.775279,1.780897,1.786448,1.791932,1.797348,1.802697,1.807978,1.813191,1.818335,1.823412,1.828419,1.833358,1.838227,1.843027,1.847759,1.852420,1.857012,1.861533,1.865985,1.870367,1.874678,1.878918,1.883088,1.887186,1.891214,1.895170,1.899056,1.902869,1.906611,1.910282,1.913880,1.917406,1.920860,1.924242,1.927552,1.930788,1.933952,1.937043,1.940062,1.943007,1.945879,1.948678,1.951404,1.954056,1.956634,1.959139,1.961570,1.963927,1.966211,1.968420,1.970555,1.972616,1.974602,1.976514,1.978352,1.980116,1.981804,1.983419,1.984958,1.986423,1.987813,1.989128,1.990369,1.991534,1.992624,1.993640,1.994580,1.995445,1.996236,1.996950,1.997590,1.998154,1.998644,1.999058,1.999397,1.999660,1.999849,1.999961};
float sine01[] = {1, 1.00614, 1.01227, 1.01841, 1.02454, 1.03067, 1.03681, 1.04294, 1.04907, 1.0552, 1.06132, 1.06744, 1.07356, 1.07968, 1.0858, 1.09191, 1.09802, 1.10412, 1.11022, 1.11632, 1.12241, 1.1285, 1.13458, 1.14066, 1.14673, 1.1528, 1.15886, 1.16491, 1.17096, 1.177, 1.18304, 1.18907, 1.19509, 1.2011, 1.20711, 1.21311, 1.2191, 1.22508, 1.23106, 1.23702, 1.24298, 1.24893, 1.25487, 1.26079, 1.26671, 1.27262, 1.27852, 1.28441, 1.29028, 1.29615, 1.30201, 1.30785, 1.31368, 1.3195, 1.32531, 1.33111, 1.33689, 1.34266, 1.34842, 1.35416, 1.35989, 1.36561, 1.37132, 1.37701, 1.38268, 1.38835, 1.39399, 1.39962, 1.40524, 1.41084, 1.41643, 1.422, 1.42756, 1.43309, 1.43862, 1.44412, 1.44961, 1.45508, 1.46054, 1.46598, 1.4714, 1.4768, 1.48218, 1.48755, 1.4929, 1.49823, 1.50354, 1.50883, 1.5141, 1.51936, 1.52459, 1.5298, 1.535, 1.54017, 1.54533, 1.55046, 1.55557, 1.56066, 1.56573, 1.57078, 1.57581, 1.58081, 1.5858, 1.59076, 1.5957, 1.60062, 1.60551, 1.61038, 1.61523, 1.62006, 1.62486, 1.62964, 1.63439, 1.63912, 1.64383, 1.64851, 1.65317, 1.65781, 1.66242, 1.667, 1.67156, 1.67609, 1.6806, 1.68508, 1.68954, 1.69397, 1.69838, 1.70275, 1.70711, 1.71143, 1.71573, 1.72, 1.72425, 1.72846, 1.73265, 1.73682, 1.74095, 1.74506, 1.74914, 1.75319, 1.75721, 1.7612, 1.76517, 1.7691, 1.77301, 1.77689, 1.78074, 1.78456, 1.78835, 1.79211, 1.79584, 1.79954, 1.80321, 1.80685, 1.81046, 1.81404, 1.81758, 1.8211, 1.82459, 1.82805, 1.83147, 1.83486, 1.83822, 1.84155, 1.84485, 1.84812, 1.85136, 1.85456, 1.85773, 1.86087, 1.86397, 1.86705, 1.87009, 1.8731, 1.87607, 1.87901, 1.88192, 1.8848, 1.88764, 1.89045, 1.89322, 1.89597, 1.89867, 1.90135, 1.90399, 1.9066, 1.90917, 1.91171, 1.91421, 1.91668, 1.91911, 1.92151, 1.92388, 1.92621, 1.92851, 1.93077, 1.93299, 1.93518, 1.93734, 1.93946, 1.94154, 1.94359, 1.94561, 1.94759, 1.94953, 1.95143, 1.95331, 1.95514, 1.95694, 1.9587, 1.96043, 1.96212, 1.96378, 1.96539, 1.96698, 1.96852, 1.97003, 1.9715, 1.97294, 1.97434, 1.9757, 1.97703, 1.97832, 1.97957, 1.98079, 1.98196, 1.98311, 1.98421, 1.98528, 1.98631, 1.9873, 1.98826, 1.98918, 1.99006, 1.9909, 1.99171, 1.99248, 1.99321, 1.99391, 1.99456, 1.99518, 1.99577, 1.99631, 1.99682, 1.99729, 1.99772, 1.99812, 1.99848, 1.9988, 1.99908, 1.99932, 1.99953, 1.9997, 1.99983, 1.99992, 1.99998, 2, 1.99998, 1.99992, 1.99983, 1.9997, 1.99953, 1.99932, 1.99908, 1.9988, 1.99848, 1.99812, 1.99772, 1.99729, 1.99682, 1.99631, 1.99577, 1.99518, 1.99456, 1.99391, 1.99321, 1.99248, 1.99171, 1.9909, 1.99006, 1.98918, 1.98826, 1.9873, 1.98631, 1.98528, 1.98421, 1.98311, 1.98196, 1.98079, 1.97957, 1.97832, 1.97703, 1.9757, 1.97434, 1.97294, 1.9715, 1.97003, 1.96852, 1.96698, 1.96539, 1.96378, 1.96212, 1.96043, 1.9587, 1.95694, 1.95514, 1.95331, 1.95143, 1.94953, 1.94759, 1.94561, 1.94359, 1.94154, 1.93946, 1.93734, 1.93518, 1.93299, 1.93077, 1.92851, 1.92621, 1.92388, 1.92151, 1.91911, 1.91668, 1.91421, 1.91171, 1.90917, 1.9066, 1.90399, 1.90135, 1.89867, 1.89597, 1.89322, 1.89045, 1.88764, 1.8848, 1.88192, 1.87901, 1.87607, 1.8731, 1.87009, 1.86705, 1.86397, 1.86087, 1.85773, 1.85456, 1.85136, 1.84812, 1.84485, 1.84155, 1.83822, 1.83486, 1.83147, 1.82805, 1.82459, 1.8211, 1.81758, 1.81404, 1.81046, 1.80685, 1.80321, 1.79954, 1.79584, 1.79211, 1.78835, 1.78456, 1.78074, 1.77689, 1.77301, 1.7691, 1.76517, 1.7612, 1.75721, 1.75319, 1.74914, 1.74506, 1.74095, 1.73682, 1.73265, 1.72846, 1.72425, 1.72, 1.71573, 1.71143, 1.70711, 1.70275, 1.69838, 1.69397, 1.68954, 1.68508, 1.6806, 1.67609, 1.67156, 1.667, 1.66242, 1.65781, 1.65317, 1.64851, 1.64383, 1.63912, 1.63439, 1.62964, 1.62486, 1.62006, 1.61523, 1.61038, 1.60551, 1.60062, 1.5957, 1.59076, 1.5858, 1.58081, 1.57581, 1.57078, 1.56573, 1.56066, 1.55557, 1.55046, 1.54533, 1.54017, 1.535, 1.5298, 1.52459, 1.51936, 1.5141, 1.50883, 1.50354, 1.49823, 1.4929, 1.48755, 1.48218, 1.4768, 1.4714, 1.46598, 1.46054, 1.45508, 1.44961, 1.44412, 1.43862, 1.43309, 1.42756, 1.422, 1.41643, 1.41084, 1.40524, 1.39962, 1.39399, 1.38835, 1.38268, 1.37701, 1.37132, 1.36561, 1.35989, 1.35416, 1.34842, 1.34266, 1.33689, 1.33111, 1.32531, 1.3195, 1.31368, 1.30785, 1.30201, 1.29615, 1.29028, 1.28441, 1.27852, 1.27262, 1.26671, 1.26079, 1.25487, 1.24893, 1.24298, 1.23702, 1.23106, 1.22508, 1.2191, 1.21311, 1.20711, 1.2011, 1.19509, 1.18907, 1.18304, 1.177, 1.17096, 1.16491, 1.15886, 1.1528, 1.14673, 1.14066, 1.13458, 1.1285, 1.12241, 1.11632, 1.11022, 1.10412, 1.09802, 1.09191, 1.0858, 1.07968, 1.07356, 1.06744, 1.06132, 1.0552, 1.04907, 1.04294, 1.03681, 1.03067, 1.02454, 1.01841, 1.01227, 1.00614, 1, 0.993864, 0.987728, 0.981593, 0.975459, 0.969325, 0.963193, 0.957062, 0.950932, 0.944805, 0.938679, 0.932556, 0.926435, 0.920318, 0.914203, 0.908091, 0.901983, 0.895878, 0.889778, 0.883681, 0.877589, 0.871502, 0.865419, 0.859342, 0.85327, 0.847203, 0.841142, 0.835087, 0.829038, 0.822996, 0.81696, 0.810931, 0.80491, 0.798895, 0.792889, 0.78689, 0.780899, 0.774916, 0.768942, 0.762976, 0.75702, 0.751072, 0.745134, 0.739206, 0.733287, 0.727379, 0.72148, 0.715592, 0.709715, 0.703849, 0.697994, 0.69215, 0.686318, 0.680498, 0.67469, 0.668894, 0.66311, 0.657339, 0.651581, 0.645836, 0.640105, 0.634387, 0.628683, 0.622993, 0.617317, 0.611655, 0.606008, 0.600376, 0.594759, 0.589157, 0.58357, 0.578, 0.572445, 0.566906, 0.561384, 0.555878, 0.550389, 0.544916, 0.539461, 0.534024, 0.528603, 0.523201, 0.517816, 0.51245, 0.507102, 0.501772, 0.496462, 0.49117, 0.485897, 0.480644, 0.47541, 0.470196, 0.465002, 0.459829, 0.454675, 0.449542, 0.44443, 0.439338, 0.434268, 0.429219, 0.424192, 0.419186, 0.414202, 0.40924, 0.404301, 0.399384, 0.394489, 0.389617, 0.384768, 0.379943, 0.375141, 0.370362, 0.365607, 0.360876, 0.356168, 0.351486, 0.346827, 0.342193, 0.337584, 0.333, 0.328441, 0.323907, 0.319399, 0.314916, 0.310459, 0.306029, 0.301624, 0.297245, 0.292893, 0.288568, 0.284269, 0.279997, 0.275753, 0.271536, 0.267346, 0.263183, 0.259049, 0.254942, 0.250864, 0.246813, 0.242791, 0.238798, 0.234833, 0.230897, 0.22699, 0.223112, 0.219263, 0.215443, 0.211654, 0.207893, 0.204163, 0.200463, 0.196792, 0.193152, 0.189543, 0.185964, 0.182415, 0.178897, 0.175411, 0.171955, 0.16853, 0.165137, 0.161775, 0.158445, 0.155146, 0.15188, 0.148645, 0.145442, 0.142271, 0.139133, 0.136027, 0.132954, 0.129913, 0.126905, 0.12393, 0.120988, 0.118079, 0.115203, 0.11236, 0.109551, 0.106776, 0.104034, 0.101326, 0.0986512, 0.0960107, 0.0934043, 0.090832, 0.088294, 0.0857902, 0.0833209, 0.0808861, 0.078486, 0.0761205, 0.0737898, 0.0714939, 0.069233, 0.0670072, 0.0648165, 0.062661, 0.0605408, 0.0584559, 0.0564065, 0.0543927, 0.0524144, 0.0504718, 0.048565, 0.046694, 0.0448588, 0.0430597, 0.0412965, 0.0395695, 0.0378786, 0.0362239, 0.0346056, 0.0330235, 0.0314779, 0.0299687, 0.0284961, 0.02706, 0.0256606, 0.0242979, 0.0229719, 0.0216826, 0.0204302, 0.0192147, 0.0180361, 0.0168945, 0.0157899, 0.0147224, 0.0136919, 0.0126986, 0.0117424, 0.0108235, 0.00994179, 0.00909736, 0.00829025, 0.00752047, 0.00678805, 0.00609303, 0.00543543, 0.00481527, 0.00423259, 0.00368739, 0.0031797, 0.00270954, 0.00227693, 0.00188189, 0.00152442, 0.00120454, 0.000922272, 0.000677615, 0.000470583, 0.000301181, 0.000169418, 7.52982e-05, 1.88247e-05, 0, 1.88247e-05, 7.52982e-05, 0.000169418, 0.000301181, 0.000470583, 0.000677615, 0.000922272, 0.00120454, 0.00152442, 0.00188189, 0.00227693, 0.00270954, 0.0031797, 0.00368739, 0.00423259, 0.00481527, 0.00543543, 0.00609303, 0.00678805, 0.00752047, 0.00829025, 0.00909736, 0.00994179, 0.0108235, 0.0117424, 0.0126986, 0.0136919, 0.0147224, 0.0157899, 0.0168945, 0.0180361, 0.0192147, 0.0204302, 0.0216826, 0.0229719, 0.0242979, 0.0256606, 0.02706, 0.0284961, 0.0299687, 0.0314779, 0.0330235, 0.0346056, 0.0362239, 0.0378786, 0.0395695, 0.0412965, 0.0430597, 0.0448588, 0.046694, 0.048565, 0.0504718, 0.0524144, 0.0543927, 0.0564065, 0.0584559, 0.0605408, 0.062661, 0.0648165, 0.0670072, 0.069233, 0.0714939, 0.0737898, 0.0761205, 0.078486, 0.0808861, 0.0833209, 0.0857902, 0.088294, 0.090832, 0.0934043, 0.0960107, 0.0986512, 0.101326, 0.104034, 0.106776, 0.109551, 0.11236, 0.115203, 0.118079, 0.120988, 0.12393, 0.126905, 0.129913, 0.132954, 0.136027, 0.139133, 0.142271, 0.145442, 0.148645, 0.15188, 0.155146, 0.158445, 0.161775, 0.165137, 0.16853, 0.171955, 0.175411, 0.178897, 0.182415, 0.185964, 0.189543, 0.193152, 0.196792, 0.200463, 0.204163, 0.207893, 0.211654, 0.215443, 0.219263, 0.223112, 0.22699, 0.230897, 0.234833, 0.238798, 0.242791, 0.246813, 0.250864, 0.254942, 0.259049, 0.263183, 0.267346, 0.271536, 0.275753, 0.279997, 0.284269, 0.288568, 0.292893, 0.297245, 0.301624, 0.306029, 0.310459, 0.314916, 0.319399, 0.323907, 0.328441, 0.333, 0.337584, 0.342193, 0.346827, 0.351486, 0.356168, 0.360876, 0.365607, 0.370362, 0.375141, 0.379943, 0.384768, 0.389617, 0.394489, 0.399384, 0.404301, 0.40924, 0.414202, 0.419186, 0.424192, 0.429219, 0.434268, 0.439338, 0.44443, 0.449542, 0.454675, 0.459829, 0.465002, 0.470196, 0.47541, 0.480644, 0.485897, 0.49117, 0.496462, 0.501772, 0.507102, 0.51245, 0.517816, 0.523201, 0.528603, 0.534024, 0.539461, 0.544916, 0.550389, 0.555878, 0.561384, 0.566906, 0.572445, 0.578, 0.58357, 0.589157, 0.594759, 0.600376, 0.606008, 0.611655, 0.617317, 0.622993, 0.628683, 0.634387, 0.640105, 0.645836, 0.651581, 0.657339, 0.66311, 0.668894, 0.67469, 0.680498, 0.686318, 0.69215, 0.697994, 0.703849, 0.709715, 0.715592, 0.72148, 0.727379, 0.733287, 0.739206, 0.745134, 0.751072, 0.75702, 0.762976, 0.768942, 0.774916, 0.780899, 0.78689, 0.792889, 0.798895, 0.80491, 0.810931, 0.81696, 0.822996, 0.829038, 0.835087, 0.841142, 0.847203, 0.85327, 0.859342, 0.865419, 0.871502, 0.877589, 0.883681, 0.889778, 0.895878, 0.901983, 0.908091, 0.914203, 0.920318, 0.926435, 0.932556, 0.938679, 0.944805, 0.950932, 0.957062, 0.963193, 0.969325, 0.975459, 0.981593, 0.987728, 0.993864};
float sine00[] = {0, 1.88247e-05, 7.52982e-05, 0.000169418, 0.000301181, 0.000470583, 0.000677615, 0.000922272, 0.00120454, 0.00152442, 0.00188189, 0.00227693, 0.00270954, 0.0031797, 0.00368739, 0.00423259, 0.00481527, 0.00543543, 0.00609303, 0.00678805, 0.00752047, 0.00829025, 0.00909736, 0.00994179, 0.0108235, 0.0117424, 0.0126986, 0.0136919, 0.0147224, 0.0157899, 0.0168945, 0.0180361, 0.0192147, 0.0204302, 0.0216826, 0.0229719, 0.0242979, 0.0256606, 0.02706, 0.0284961, 0.0299687, 0.0314779, 0.0330235, 0.0346056, 0.0362239, 0.0378786, 0.0395695, 0.0412965, 0.0430597, 0.0448588, 0.046694, 0.048565, 0.0504718, 0.0524144, 0.0543927, 0.0564065, 0.0584559, 0.0605408, 0.062661, 0.0648165, 0.0670072, 0.069233, 0.0714939, 0.0737898, 0.0761205, 0.078486, 0.0808861, 0.0833209, 0.0857902, 0.088294, 0.090832, 0.0934043, 0.0960107, 0.0986512, 0.101326, 0.104034, 0.106776, 0.109551, 0.11236, 0.115203, 0.118079, 0.120988, 0.12393, 0.126905, 0.129913, 0.132954, 0.136027, 0.139133, 0.142271, 0.145442, 0.148645, 0.15188, 0.155146, 0.158445, 0.161775, 0.165137, 0.16853, 0.171955, 0.175411, 0.178897, 0.182415, 0.185964, 0.189543, 0.193152, 0.196792, 0.200463, 0.204163, 0.207893, 0.211654, 0.215443, 0.219263, 0.223112, 0.22699, 0.230897, 0.234833, 0.238798, 0.242791, 0.246813, 0.250864, 0.254942, 0.259049, 0.263183, 0.267346, 0.271536, 0.275753, 0.279997, 0.284269, 0.288568, 0.292893, 0.297245, 0.301624, 0.306029, 0.310459, 0.314916, 0.319399, 0.323907, 0.328441, 0.333, 0.337584, 0.342193, 0.346827, 0.351486, 0.356168, 0.360876, 0.365607, 0.370362, 0.375141, 0.379943, 0.384768, 0.389617, 0.394489, 0.399384, 0.404301, 0.40924, 0.414202, 0.419186, 0.424192, 0.429219, 0.434268, 0.439338, 0.44443, 0.449542, 0.454675, 0.459829, 0.465002, 0.470196, 0.47541, 0.480644, 0.485897, 0.49117, 0.496462, 0.501772, 0.507102, 0.51245, 0.517816, 0.523201, 0.528603, 0.534024, 0.539461, 0.544916, 0.550389, 0.555878, 0.561384, 0.566906, 0.572445, 0.578, 0.58357, 0.589157, 0.594759, 0.600376, 0.606008, 0.611655, 0.617317, 0.622993, 0.628683, 0.634387, 0.640105, 0.645836, 0.651581, 0.657339, 0.66311, 0.668894, 0.67469, 0.680498, 0.686318, 0.69215, 0.697994, 0.703849, 0.709715, 0.715592, 0.72148, 0.727379, 0.733287, 0.739206, 0.745134, 0.751072, 0.75702, 0.762976, 0.768942, 0.774916, 0.780899, 0.78689, 0.792889, 0.798895, 0.80491, 0.810931, 0.81696, 0.822996, 0.829038, 0.835087, 0.841142, 0.847203, 0.85327, 0.859342, 0.865419, 0.871502, 0.877589, 0.883681, 0.889778, 0.895878, 0.901983, 0.908091, 0.914203, 0.920318, 0.926435, 0.932556, 0.938679, 0.944805, 0.950932, 0.957062, 0.963193, 0.969325, 0.975459, 0.981593, 0.987728, 0.993864, 1, 1.00614, 1.01227, 1.01841, 1.02454, 1.03067, 1.03681, 1.04294, 1.04907, 1.0552, 1.06132, 1.06744, 1.07356, 1.07968, 1.0858, 1.09191, 1.09802, 1.10412, 1.11022, 1.11632, 1.12241, 1.1285, 1.13458, 1.14066, 1.14673, 1.1528, 1.15886, 1.16491, 1.17096, 1.177, 1.18304, 1.18907, 1.19509, 1.2011, 1.20711, 1.21311, 1.2191, 1.22508, 1.23106, 1.23702, 1.24298, 1.24893, 1.25487, 1.26079, 1.26671, 1.27262, 1.27852, 1.28441, 1.29028, 1.29615, 1.30201, 1.30785, 1.31368, 1.3195, 1.32531, 1.33111, 1.33689, 1.34266, 1.34842, 1.35416, 1.35989, 1.36561, 1.37132, 1.37701, 1.38268, 1.38835, 1.39399, 1.39962, 1.40524, 1.41084, 1.41643, 1.422, 1.42756, 1.43309, 1.43862, 1.44412, 1.44961, 1.45508, 1.46054, 1.46598, 1.4714, 1.4768, 1.48218, 1.48755, 1.4929, 1.49823, 1.50354, 1.50883, 1.5141, 1.51936, 1.52459, 1.5298, 1.535, 1.54017, 1.54533, 1.55046, 1.55557, 1.56066, 1.56573, 1.57078, 1.57581, 1.58081, 1.5858, 1.59076, 1.5957, 1.60062, 1.60551, 1.61038, 1.61523, 1.62006, 1.62486, 1.62964, 1.63439, 1.63912, 1.64383, 1.64851, 1.65317, 1.65781, 1.66242, 1.667, 1.67156, 1.67609, 1.6806, 1.68508, 1.68954, 1.69397, 1.69838, 1.70275, 1.70711, 1.71143, 1.71573, 1.72, 1.72425, 1.72846, 1.73265, 1.73682, 1.74095, 1.74506, 1.74914, 1.75319, 1.75721, 1.7612, 1.76517, 1.7691, 1.77301, 1.77689, 1.78074, 1.78456, 1.78835, 1.79211, 1.79584, 1.79954, 1.80321, 1.80685, 1.81046, 1.81404, 1.81758, 1.8211, 1.82459, 1.82805, 1.83147, 1.83486, 1.83822, 1.84155, 1.84485, 1.84812, 1.85136, 1.85456, 1.85773, 1.86087, 1.86397, 1.86705, 1.87009, 1.8731, 1.87607, 1.87901, 1.88192, 1.8848, 1.88764, 1.89045, 1.89322, 1.89597, 1.89867, 1.90135, 1.90399, 1.9066, 1.90917, 1.91171, 1.91421, 1.91668, 1.91911, 1.92151, 1.92388, 1.92621, 1.92851, 1.93077, 1.93299, 1.93518, 1.93734, 1.93946, 1.94154, 1.94359, 1.94561, 1.94759, 1.94953, 1.95143, 1.95331, 1.95514, 1.95694, 1.9587, 1.96043, 1.96212, 1.96378, 1.96539, 1.96698, 1.96852, 1.97003, 1.9715, 1.97294, 1.97434, 1.9757, 1.97703, 1.97832, 1.97957, 1.98079, 1.98196, 1.98311, 1.98421, 1.98528, 1.98631, 1.9873, 1.98826, 1.98918, 1.99006, 1.9909, 1.99171, 1.99248, 1.99321, 1.99391, 1.99456, 1.99518, 1.99577, 1.99631, 1.99682, 1.99729, 1.99772, 1.99812, 1.99848, 1.9988, 1.99908, 1.99932, 1.99953, 1.9997, 1.99983, 1.99992, 1.99998, 2, 1.99998, 1.99992, 1.99983, 1.9997, 1.99953, 1.99932, 1.99908, 1.9988, 1.99848, 1.99812, 1.99772, 1.99729, 1.99682, 1.99631, 1.99577, 1.99518, 1.99456, 1.99391, 1.99321, 1.99248, 1.99171, 1.9909, 1.99006, 1.98918, 1.98826, 1.9873, 1.98631, 1.98528, 1.98421, 1.98311, 1.98196, 1.98079, 1.97957, 1.97832, 1.97703, 1.9757, 1.97434, 1.97294, 1.9715, 1.97003, 1.96852, 1.96698, 1.96539, 1.96378, 1.96212, 1.96043, 1.9587, 1.95694, 1.95514, 1.95331, 1.95143, 1.94953, 1.94759, 1.94561, 1.94359, 1.94154, 1.93946, 1.93734, 1.93518, 1.93299, 1.93077, 1.92851, 1.92621, 1.92388, 1.92151, 1.91911, 1.91668, 1.91421, 1.91171, 1.90917, 1.9066, 1.90399, 1.90135, 1.89867, 1.89597, 1.89322, 1.89045, 1.88764, 1.8848, 1.88192, 1.87901, 1.87607, 1.8731, 1.87009, 1.86705, 1.86397, 1.86087, 1.85773, 1.85456, 1.85136, 1.84812, 1.84485, 1.84155, 1.83822, 1.83486, 1.83147, 1.82805, 1.82459, 1.8211, 1.81758, 1.81404, 1.81046, 1.80685, 1.80321, 1.79954, 1.79584, 1.79211, 1.78835, 1.78456, 1.78074, 1.77689, 1.77301, 1.7691, 1.76517, 1.7612, 1.75721, 1.75319, 1.74914, 1.74506, 1.74095, 1.73682, 1.73265, 1.72846, 1.72425, 1.72, 1.71573, 1.71143, 1.70711, 1.70275, 1.69838, 1.69397, 1.68954, 1.68508, 1.6806, 1.67609, 1.67156, 1.667, 1.66242, 1.65781, 1.65317, 1.64851, 1.64383, 1.63912, 1.63439, 1.62964, 1.62486, 1.62006, 1.61523, 1.61038, 1.60551, 1.60062, 1.5957, 1.59076, 1.5858, 1.58081, 1.57581, 1.57078, 1.56573, 1.56066, 1.55557, 1.55046, 1.54533, 1.54017, 1.535, 1.5298, 1.52459, 1.51936, 1.5141, 1.50883, 1.50354, 1.49823, 1.4929, 1.48755, 1.48218, 1.4768, 1.4714, 1.46598, 1.46054, 1.45508, 1.44961, 1.44412, 1.43862, 1.43309, 1.42756, 1.422, 1.41643, 1.41084, 1.40524, 1.39962, 1.39399, 1.38835, 1.38268, 1.37701, 1.37132, 1.36561, 1.35989, 1.35416, 1.34842, 1.34266, 1.33689, 1.33111, 1.32531, 1.3195, 1.31368, 1.30785, 1.30201, 1.29615, 1.29028, 1.28441, 1.27852, 1.27262, 1.26671, 1.26079, 1.25487, 1.24893, 1.24298, 1.23702, 1.23106, 1.22508, 1.2191, 1.21311, 1.20711, 1.2011, 1.19509, 1.18907, 1.18304, 1.177, 1.17096, 1.16491, 1.15886, 1.1528, 1.14673, 1.14066, 1.13458, 1.1285, 1.12241, 1.11632, 1.11022, 1.10412, 1.09802, 1.09191, 1.0858, 1.07968, 1.07356, 1.06744, 1.06132, 1.0552, 1.04907, 1.04294, 1.03681, 1.03067, 1.02454, 1.01841, 1.01227, 1.00614, 1, 0.993864, 0.987728, 0.981593, 0.975459, 0.969325, 0.963193, 0.957062, 0.950932, 0.944805, 0.938679, 0.932556, 0.926435, 0.920318, 0.914203, 0.908091, 0.901983, 0.895878, 0.889778, 0.883681, 0.877589, 0.871502, 0.865419, 0.859342, 0.85327, 0.847203, 0.841142, 0.835087, 0.829038, 0.822996, 0.81696, 0.810931, 0.80491, 0.798895, 0.792889, 0.78689, 0.780899, 0.774916, 0.768942, 0.762976, 0.75702, 0.751072, 0.745134, 0.739206, 0.733287, 0.727379, 0.72148, 0.715592, 0.709715, 0.703849, 0.697994, 0.69215, 0.686318, 0.680498, 0.67469, 0.668894, 0.66311, 0.657339, 0.651581, 0.645836, 0.640105, 0.634387, 0.628683, 0.622993, 0.617317, 0.611655, 0.606008, 0.600376, 0.594759, 0.589157, 0.58357, 0.578, 0.572445, 0.566906, 0.561384, 0.555878, 0.550389, 0.544916, 0.539461, 0.534024, 0.528603, 0.523201, 0.517816, 0.51245, 0.507102, 0.501772, 0.496462, 0.49117, 0.485897, 0.480644, 0.47541, 0.470196, 0.465002, 0.459829, 0.454675, 0.449542, 0.44443, 0.439338, 0.434268, 0.429219, 0.424192, 0.419186, 0.414202, 0.40924, 0.404301, 0.399384, 0.394489, 0.389617, 0.384768, 0.379943, 0.375141, 0.370362, 0.365607, 0.360876, 0.356168, 0.351486, 0.346827, 0.342193, 0.337584, 0.333, 0.328441, 0.323907, 0.319399, 0.314916, 0.310459, 0.306029, 0.301624, 0.297245, 0.292893, 0.288568, 0.284269, 0.279997, 0.275753, 0.271536, 0.267346, 0.263183, 0.259049, 0.254942, 0.250864, 0.246813, 0.242791, 0.238798, 0.234833, 0.230897, 0.22699, 0.223112, 0.219263, 0.215443, 0.211654, 0.207893, 0.204163, 0.200463, 0.196792, 0.193152, 0.189543, 0.185964, 0.182415, 0.178897, 0.175411, 0.171955, 0.16853, 0.165137, 0.161775, 0.158445, 0.155146, 0.15188, 0.148645, 0.145442, 0.142271, 0.139133, 0.136027, 0.132954, 0.129913, 0.126905, 0.12393, 0.120988, 0.118079, 0.115203, 0.11236, 0.109551, 0.106776, 0.104034, 0.101326, 0.0986512, 0.0960107, 0.0934043, 0.090832, 0.088294, 0.0857902, 0.0833209, 0.0808861, 0.078486, 0.0761205, 0.0737898, 0.0714939, 0.069233, 0.0670072, 0.0648165, 0.062661, 0.0605408, 0.0584559, 0.0564065, 0.0543927, 0.0524144, 0.0504718, 0.048565, 0.046694, 0.0448588, 0.0430597, 0.0412965, 0.0395695, 0.0378786, 0.0362239, 0.0346056, 0.0330235, 0.0314779, 0.0299687, 0.0284961, 0.02706, 0.0256606, 0.0242979, 0.0229719, 0.0216826, 0.0204302, 0.0192147, 0.0180361, 0.0168945, 0.0157899, 0.0147224, 0.0136919, 0.0126986, 0.0117424, 0.0108235, 0.00994179, 0.00909736, 0.00829025, 0.00752047, 0.00678805, 0.00609303, 0.00543543, 0.00481527, 0.00423259, 0.00368739, 0.0031797, 0.00270954, 0.00227693, 0.00188189, 0.00152442, 0.00120454, 0.000922272, 0.000677615, 0.000470583, 0.000301181, 0.000169418, 7.52982e-05, 1.88247e-05};

unsigned microseconds(void) {
    struct timespec ts;
    clock_gettime(CLOCK_REALTIME, &ts);
    return ts.tv_sec*1000000 + ts.tv_nsec/1000;
}

int main(int argc, char *argv[]) {
    int i, j, k, ret, loops, freq, log2_N, jobs, N;
    int mailbox = mbox_open();      // mailbox descriptor
    unsigned t[2];
    ofstream fr("plot_real.txt");
    ofstream fi("plot_img.txt");

    /*
    struct GPU_FFT_COMPLEX {
    float re, im;
    };
    */
    struct GPU_FFT_COMPLEX *base;

    /*
    struct GPU_FFT {
    struct GPU_FFT_BASE base;
    struct GPU_FFT_COMPLEX *in, *out;
    int x, y, step;
    };
    */
    struct GPU_FFT *fft;

    log2_N = 10; //argc>1? atoi(argv[1]) : 12; // 8 <= log2_N <= 22
    jobs   = 1;	//argc>2? atoi(argv[2]) : 1;  // transforms per batch
    loops  = 1;	//argc>3? atoi(argv[3]) : 1;  // test repetitions

    N = 1<<log2_N; // FFT length
    // init the fields if GPU_FFT* fft
    ret = gpu_fft_prepare(mailbox, log2_N, GPU_FFT_REV, jobs, &fft); // call once

    switch(ret) {
        case -1: printf("Unable to enable V3D. Please check your firmware is up to date.\n"); return -1;
        case -2: printf("log2_N=%d not supported.  Try between 8 and 22.\n", log2_N);         return -1;
        case -3: printf("Out of memory.  Try a smaller batch or increase GPU memory.\n");     return -1;
        case -4: printf("Unable to map Videocore peripherals into ARM memory space.\n");      return -1;
        case -5: printf("Can't open libbcm_host.\n");                                         return -1;
    }

    // run 1 job (jobs = 1, j=0) for 1 loop (k=0)
    // convert to forward FFT, input: an array of sin(2*pi*freq*i/N)
    //                                  i=0, N-1;
    //                          output: the frequency domain of the input:

    // set the input data
    base = fft->in + 0*fft->step; // input buffer

    for (int i=0; i<N; i++) {
        base[i].re = 0;
	base[i].im = 0;
    }
    /*
	In order to get a sine wave of freq. f as output, (in [-2, 2]), set base[f]
	and base[N-f] to 1.
    */
	int f = atoi(argv[1]);
	base[f].re = 1;
	base[N-f].im = 1;
	//base[3].re = 1;
	//base[N-3].re = 1;

    usleep(1); // Yield to OS
    // timing call
    gpu_fft_execute(fft);   // do the transform
    // timing call

    //j=0, N=FFT length
    base = fft->out + 0*fft->step; // output buffer

    // print results
    vector<float> reals, imaginaries, s;

    for(int i=0; i<N; i++) {
	fr<<base[i].re<<",";
	fi<<base[i].im<<",";
        reals.push_back(base[i].re);
	imaginaries.push_back(base[i].im);
    }

    printf("%d ", N);

    printf("\nReals:");
    for(float& re : reals)
	printf("%f ", re);

    printf("\n\n\n\Imaginaries:");
    for(float& im : imaginaries)
	printf("%f ", im);

    printf("\n\n\nSum:");

    for(int i=0; i<N; i++)
	printf("%f ", (pow(reals[i], 2)+pow(imaginaries[i], 2)));

    printf("\n");
    fr.close();
    fi.close();


    gpu_fft_release(fft); // Videocore memory lost if not freed !
    return 0;
}
